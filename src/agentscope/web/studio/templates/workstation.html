<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <title>AgentScope | {{ _("WorkStation") }}</title>
    <meta content="AgentScope WorkStation for flow programming multi-agent Applications."
          name="description">
    <link href="https://img.alicdn.com/imgextra/i3/O1CN01BP6UV221Lr7crkYBo_!!6000000006969-2-tps-380-372.png"
          rel="icon"
          type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism.min.css"
          rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css"
          rel="stylesheet"/>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
<script crossorigin="anonymous"
        integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs="
        src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
<link href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow@0.0.48/dist/drawflow.min.css"
      rel="stylesheet">
<link href="{{ url_for('static', filename='css/workstation.css') }}"
      rel="stylesheet" type="text/css"/>
<link crossorigin="anonymous"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css"
      integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ="
      rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet">
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>


<header>
    <h2><i class="fa fa-desktop"></i> AgentScope {{ _("WorkStation") }}</h2>
    <div class="github-link"><a href="https://github.com/modelscope/agentscope"
                                target="_blank"><i
            class="fab fa-github fa-3x"></i></a></div>
    <div>
        <a class="github-button"
           href="https://github.com/modelscope/agentscope"
           data-color-scheme="no-preference: light; light: light; dark: dark;"
           data-icon="octicon-star" data-size="large" data-show-count="true"
           aria-label="Star modelscope/agentscope on GitHub">Star</a>

        <a class="github-button"
           href="https://github.com/modelscope/agentscope/fork"
           data-color-scheme="no-preference: light; light: light; dark: dark;"
           data-icon="octicon-repo-forked" data-size="large"
           data-show-count="true"
           aria-label="Fork modelscope/agentscope on GitHub">Fork</a>

        <a class="github-button"
           href="https://github.com/modelscope/agentscope/subscription"
           data-color-scheme="no-preference: light; light: light; dark: dark;"
           data-icon="octicon-eye" data-size="large" data-show-count="true"
           aria-label="Watch modelscope/agentscope on GitHub">Watch</a>
    </div>
    <a href="https://github.com/modelscope/agentscope"
       style="display: block; margin: 10px 0 10px 0; margin-right: 60px;"
       target="_blank">
        AgentScope
    </a>
</header>
<div class="wrapper">
    <div class="col">
        <h3 class="highlighted-title" onclick="toggleDraggable(this)">
            {{ _("Examples") }}
        </h3>
        <div class="draggable-content visible">
            <div class="example-wrapper">
                <div class="toggle-sub-title" onclick="importExample(1)"
                     style="text-align: left; background-color: rgba(173, 216,
                     230, 0.3); margin-bottom: 5px;">
                    <i class="fas fa-play-circle"></i>
                    <span>
                        {{ _("Two Agents") }}
                    </span>
                </div>
                <div class="new-action" onclick="importExample_step(1)">
                    <i class="fas fa-book-open"></i>
                </div>
            </div>
            <div class="example-wrapper">
                <div class="toggle-sub-title" onclick="importExample(2)"
                     style="text-align: left; background-color: rgba(173, 216,
                     230, 0.3); margin-bottom: 5px;">
                    <i class="fas fa-play-circle"></i>
                    <span>
                        {{ _("Pipeline") }}
                    </span>
                </div>
                <div class="new-action" onclick="importExample_step(2)">
                    <i class="fas fa-book-open"></i>
                </div>
            </div>
            <div class="example-wrapper">
                <div class="toggle-sub-title" onclick="importExample(3)"
                     style="text-align: left; background-color: rgba(173, 216,
                     230, 0.3); margin-bottom: 5px;">
                    <i class="fas fa-play-circle"></i>
                    <span>
                        {{ _("Conversation") }}
                    </span>
                </div>
                <div class="new-action" onclick="importExample_step(3)">
                    <i class="fas fa-book-open"></i>
                </div>
            </div>
            <div class="example-wrapper">
                <div class="toggle-sub-title" onclick="importExample(4)"
                     style="text-align: left; background-color: rgba(173, 216,
                     230, 0.3); margin-bottom: 5px;">
                    <i class="fas fa-play-circle"></i>
                    <span>
                        {{ _("Group Chat") }}
                    </span>
                </div>
                <div class="new-action" onclick="importExample_step(4)">
                    <i class="fas fa-book-open"></i>
                </div>
            </div>
        </div>
        <h3 class="toggle-title" onclick="toggleDraggable(this)">
            {{ _("Workflow") }}</h3>
        <div class="draggable-content visible">
            <h4 class="toggle-sub-title" onclick="toggleDraggable(this)">
                {{ _("Model") }}</h4>
            <div class="draggable-content visible">
                <div class="drag-drawflow" data-node="dashscope_chat"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-brain"></i><span> DashScope Chat </span>
                </div>
                <div class="drag-drawflow" data-node="openai_chat"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-brain"></i><span> OpenAI Chat </span>
                </div>
                <div class="drag-drawflow" data-node="post_api_chat"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-brain"></i><span> Post API Chat </span>
                </div>
                <div class="drag-drawflow" data-node="post_api_dall_e"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-brain"></i><span> Post API Dall-E </span>
                </div>
            </div>
            <h4 class="toggle-sub-title" onclick="toggleDraggable(this)">
                {{ _("Message") }}</h4>
            <div class="draggable-content">
                <div class="drag-drawflow" data-node="Message"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-comment-dots"></i><span> Message </span>
                </div>
            </div>
            <h4 class="toggle-sub-title" onclick="toggleDraggable(this)">
                {{ _("Agent") }}</h4>
            <div class="draggable-content">
                <div class="drag-drawflow" data-node="DialogAgent"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-robot"></i><span> DialogAgent</span>
                </div>
                <div class="drag-drawflow" data-node="UserAgent"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-robot"></i><span> UserAgent</span>
                </div>
                <div class="drag-drawflow" data-node="TextToImageAgent"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-robot"></i><span> TextToImageAgent</span>
                </div>
                <div class="drag-drawflow" data-node="DictDialogAgent"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-robot"></i><span> DictDialogAgent</span>
                </div>
                <div class="drag-drawflow" data-node="ReActAgent"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-robot"></i><span> ReActAgent</span>
                </div>
            </div>
            <h4 class="toggle-sub-title" onclick="toggleDraggable(this)">
                {{ _("Pipeline") }}</h4>
            <div class="draggable-content">
                <div class="drag-drawflow" data-node="Placeholder"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-project-diagram"></i><span> Placeholder</span>
                </div>
                <div class="drag-drawflow" data-node="MsgHub"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-project-diagram"></i><span> MsgHub</span>
                </div>
                <div class="drag-drawflow" data-node="SequentialPipeline"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-project-diagram"></i><span> SequentialPipeline</span>
                </div>
                <div class="drag-drawflow" data-node="ForLoopPipeline"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-project-diagram"></i><span> ForLoopPipeline</span>
                </div>
                <div class="drag-drawflow" data-node="WhileLoopPipeline"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-project-diagram"></i><span> WhileLoopPipeline</span>
                </div>
                <div class="drag-drawflow" data-node="IfElsePipeline"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-project-diagram"></i><span> IfElsePipeline</span>
                </div>
                <div class="drag-drawflow" data-node="SwitchPipeline"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-project-diagram"></i><span> SwitchPipeline
                </span>
                </div>
            </div>
            <h4 class="toggle-sub-title" onclick="toggleDraggable(this)">
                {{ _("Tool") }}</h4>
            <div class="draggable-content">
                <div class="drag-drawflow" data-node="BingSearchService"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-hammer"></i><span> Bing Search
                </span>
                </div>
                <div class="drag-drawflow" data-node="GoogleSearchService"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-hammer"></i><span> Google Search
                </span>
                </div>
                <div class="drag-drawflow" data-node="PythonService"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-hammer"></i><span> Python Interpreter
                </span>
                </div>
                <div class="drag-drawflow" data-node="ReadTextService"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-hammer"></i><span> Read Text
                </span>
                </div>
                <div class="drag-drawflow" data-node="WriteTextService"
                     draggable="true" ondragstart="drag(event)">
                    <i class="fas fa-hammer"></i><span> Write Text
                </span>
                </div>
            </div>
        </div>


    </div>
    <div class="col-right">
        <div class="menu">
            <ul>
                <li class="selected"
                    onclick="editor.changeModule('Home'); changeModule(event);">
                    &nbsp;{{ _("Home") }}&nbsp;
                </li>
                <!--           Uncomment to add more tab-->
            </ul>
        </div>
        <div id="drawflow" ondragover="allowDrop(event)" ondrop="drop(event)">
            <div class="buttons-container-html">
                <div class="btn-export-html" onclick="showExportHTMLPopup()">
                    {{ _("Export HTML") }}
                </div>
                <div class="btn-import-html" onclick="showImportHTMLPopup()">
                    {{ _("Import HTML") }}
                </div>
            </div>

            <div class="buttons-container">
                <div class="btn-check" onclick="showCheckPopup()">
                    {{ _("Check") }}
                </div>
                <div class="btn-clear" onclick="clearModuleSelected()">
                    {{ _("Clear") }}
                </div>
                <div class="btn-cover"
                     data-title="Please click the 'Check' button first.">
                    <div class="btn-export-py btn-disabled"
                         onclick="showExportPyPopup()">
                        {{ _("Export Python") }}
                    </div>
                </div>
                <div class="btn-cover"
                     data-title="Please click the 'Check' button first.">
                    <div class="btn-export-config btn-disabled"
                         onclick="showExportRunPopup()">
                        {{ _("Run") }}
                    </div>
                </div>

            </div>
            <div class="btn-lock">
                <i class="fas fa-lock" id="lock"
                   onclick="editor.editor_mode='fixed'; changeMode('lock');"></i>
                <i class="fas fa-lock-open" id="unlock"
                   onclick="editor.editor_mode='edit'; changeMode('unlock');"
                   style="display:none;"></i>
            </div>
            <div class="bar-zoom">
                <i class="fas fa-search-minus" onclick="editor.zoom_out()"></i>
                <i class="fas fa-search" onclick="editor.zoom_reset()"></i>
                <i class="fas fa-search-plus" onclick="editor.zoom_in()"></i>
            </div>
        </div>
    </div>
</div>

<div id="surveyModal">
    <div id="surveyContent">
        <span id="surveyClose">&times;</span>
        <h3>{{ _("We want to hear from you") }}</h3>
        <button id="surveyButton">{{ _("Participation in questionnaire
            surveys") }}
        </button>
    </div>
</div>

<script>
    var id = document.getElementById("drawflow");
    const editor = new Drawflow(id);
    editor.reroute = true;
    editor.createCurvature = function (start_pos_x, start_pos_y, end_pos_x, end_pos_y, curvature_value, type) {
        var line_x = start_pos_x;
        var line_y = start_pos_y;
        var x = end_pos_x;
        var y = end_pos_y;
        var curvature = curvature_value;
        //type openclose open close other
        switch (type) {
            case 'open':
                if (start_pos_x >= end_pos_x) {
                    var hx1 = line_x + Math.abs(x - line_x) * curvature;
                    var hx2 = x - Math.abs(x - line_x) * (curvature * -1);
                } else {
                    var hx1 = line_x + Math.abs(x - line_x) * curvature;
                    var hx2 = x - Math.abs(x - line_x) * curvature;
                }
                return ' M ' + line_x + ' ' + line_y + ' C ' + hx1 + ' ' + line_y + ' ' + hx2 + ' ' + y + ' ' + x + '  ' + y;

                break
            case 'close':
                if (start_pos_x >= end_pos_x) {
                    var hx1 = line_x + Math.abs(x - line_x) * (curvature * -1);
                    var hx2 = x - Math.abs(x - line_x) * curvature;
                } else {
                    var hx1 = line_x + Math.abs(x - line_x) * curvature;
                    var hx2 = x - Math.abs(x - line_x) * curvature;
                }                                                                                                                  //M0 75H10L5 80L0 75Z

                return ' M ' + line_x + ' ' + line_y + ' C ' + hx1 + ' ' + line_y + ' ' + hx2 + ' ' + y + ' ' + x + '  ' + y + ' M ' + (x - 11) + ' ' + y + ' L' + (x - 20) + ' ' + (y - 5) + '  L' + (x - 20) + ' ' + (y + 5) + 'Z';
                break;
            case 'other':
                if (start_pos_x >= end_pos_x) {
                    var hx1 = line_x + Math.abs(x - line_x) * (curvature * -1);
                    var hx2 = x - Math.abs(x - line_x) * (curvature * -1);
                } else {
                    var hx1 = line_x + Math.abs(x - line_x) * curvature;
                    var hx2 = x - Math.abs(x - line_x) * curvature;
                }
                return ' M ' + line_x + ' ' + line_y + ' C ' + hx1 + ' ' + line_y + ' ' + hx2 + ' ' + y + ' ' + x + '  ' + y;
                break;
            default:

                var hx1 = line_x + Math.abs(x - line_x) * curvature;
                var hx2 = x - Math.abs(x - line_x) * curvature;

                return ' M ' + line_x + ' ' + line_y + ' C ' + hx1 + ' ' + line_y + ' ' + hx2 + ' ' + y + ' ' + x + '  ' + y + ' M ' + (x - 11) + ' ' + y + ' L' + (x - 20) + ' ' + (y - 5) + '  L' + (x - 20) + ' ' + (y + 5) + 'Z';
        }

    }
    editor.start();
    editor.zoom_out();

    var welcome = `
        <div class="title-box">👏 Welcome! <span class="toggle-arrow">&#x25B2;</span> </div>
        <div class="box">
          <h3>Easy-to-use multi-agent library: <a href="https://github.com/modelscope/agentscope" target="_blank">AgentScope</a></h3>

          <p><b><u>Shortkeys:</u></b></p><br>
          🤝 Easy-to-Use<br><br>
          ✅ High Robustness<br><br>
          🌐 Actor-Based Distribution<br>

           <br>
           <p><b><u>Documentations:</u></b></p><br>
           🚀 <a href="https://github.com/modelscope/agentscope/blob/main/README.md" target="_blank">Quick Start</a> <a href="https://github.com/modelscope/agentscope/blob/main/README_ZH.md" target="_blank">[CN]</a><br><br>
           💡 <a href="https://github.com/modelscope/agentscope/tree/main/examples" target="_blank">Examples</a><br><br>
           📘 <a href="https://modelscope.github.io/agentscope/en/index.html" target="_blank">Tutorial & API Reference</a> <a href="https://modelscope.github.io/agentscope/zh_CN/index.html" target="_blank">[CN]</a> <br><br>

        </div>
      </div>
      `;


    //editor.addNode(name, inputs, outputs, posx, posy, class, data, html);
    const welcomeID = editor.addNode('welcome', 0, 0, 50, 50, 'welcome', {},
        welcome);
    setupNodeListeners(welcomeID);

    // editor.addModule('Other');

    editor.on('nodeCreated', function (id) {
        console.log("Node created " + id);
        disableButtons();
        makeNodeTop(id);
        setupNodeListeners(id);
        setupNodeCopyListens(id);
        addEventListenersToNumberInputs(id);
    })

    editor.on('nodeRemoved', function (id) {
        console.log("Node removed " + id);
        disableButtons();
        Object.keys(editor.drawflow.drawflow[editor.module].data).forEach(nodeKey => {
            var node = editor.drawflow.drawflow[editor.module].data[nodeKey];
            var nodeData =
                editor.drawflow.drawflow[editor.module].data[nodeKey].data;
            console.log("nodeKey", nodeKey);
            console.log("node", node);
            console.log("nodeData", nodeData);
            console.log("id", id);

            if (nodeData && nodeData.copies) {
                console.log("Array.isArray(nodeData.copies)", Array.isArray(nodeData.copies))
                if (nodeData.copies.includes(id)) {
                    console.log("nodeData.copies", nodeData.copies);
                    console.log("nodeData.copies.includes(id)",
                        nodeData.copies.includes(id));
                    var index = nodeData.copies.indexOf(id);
                    console.log("index", index);
                    if (index > -1) {
                        nodeData.copies.splice(index, 1);
                        editor.updateNodeDataFromId(nodeKey, nodeData);
                    }
                }
            }
        })
    })

    let currentZIndex = 0;

    function makeNodeTop(id) {
        const node = document.getElementById(`node-${id}`);
        const nodeInfo = editor.getNodeFromId(id);

        if (nodeInfo) {
            currentZIndex += 1;
            node.style.zIndex = currentZIndex;

            if (nodeInfo.class === 'GROUP') {
                nodeInfo.data.elements.forEach((elementId) => {
                    makeNodeTop(elementId);
                });
            }
        }
    }

    editor.on('nodeSelected', function (id) {
        console.log("Node selected " + id);
        makeNodeTop(id);
    })

    editor.on('moduleCreated', function (name) {
        console.log("Module Created " + name);
    })

    editor.on('moduleChanged', function (name) {
        console.log("Module Changed " + name);
    })

    editor.on('connectionCreated', function (connection) {
        console.log('Connection created');
        console.log(connection);
        disableButtons();
    })

    editor.on('connectionRemoved', function (connection) {
        console.log('Connection removed');
        console.log(connection);
        disableButtons();
    })

    editor.on('mouseMove', function (position) {
        console.log('Position mouse x:' + position.x + ' y:' + position.y);
    })

    editor.on('nodeMoved', function (id) {
        console.log("Node moved " + id);
        disableButtons();
    })

    editor.on('zoom', function (zoom) {
        console.log('Zoom level ' + zoom);
    })

    editor.on('translate', function (position) {
        console.log('Translate x:' + position.x + ' y:' + position.y);
    })

    editor.on('addReroute', function (id) {
        console.log("Reroute added " + id);
    })

    editor.on('removeReroute', function (id) {
        console.log("Reroute removed " + id);
    })

    editor.selectNode = function (id) {
        if (this.node_selected != null) {
            this.node_selected.classList.remove("selected");
            if (this.node_selected != this.ele_selected) {
                this.dispatch('nodeUnselected', true);
            }
        }
        const element = document.querySelector(`#node-${id}`);
        this.ele_selected = element;
        this.node_selected = element;
        this.node_selected.classList.add("selected");
        if (this.node_selected != this.ele_selected) {
            this.node_selected = element;
            this.node_selected.classList.add('selected');
            this.dispatch('nodeSelected', this.ele_selected.id.slice(5));
        }
        console.log(id)
    }


    let last_x = 0;
    let last_y = 0;
    let dragElementHover = null;

    editor.on("mouseMove", ({x, y}) => {
        const hoverEles = document.elementsFromPoint(x, y);
        const nextGroup = hoverEles.find(ele => ele.classList.contains('GROUP') && (!editor.node_selected || ele.id !== editor.node_selected.id));

        if (nextGroup) {
            if (dragElementHover !== nextGroup) {
                if (dragElementHover) {
                    dragElementHover.classList.remove("hover-drop");
                }
                dragElementHover = nextGroup;
                dragElementHover.classList.add("hover-drop");
            }
        } else if (dragElementHover) {
            dragElementHover.classList.remove("hover-drop");
            dragElementHover = null;
        }

        if (editor.node_selected && editor.drag) {
            const selectedNodeId = editor.node_selected.id.slice(5);
            var dx = (last_x - x) * editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom);
            var dy = (last_y - y) * editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom);

            if (editor.node_selected.classList.contains("GROUP")) {
                moveGroupNodes(selectedNodeId, -dx, -dy);
            }
        } else {
            if (dragElementHover) {
                dragElementHover.classList.remove("hover-drop");
                dragElementHover = null;
            }
        }

        last_x = x;
        last_y = y;
    });

    function moveGroupNodes(groupId, dx, dy) {
        const groupInfo = editor.getNodeFromId(groupId);
        const elements = groupInfo.data.elements || [];
        elements.forEach(eleId => {
            const eleNode = document.getElementById(`node-${eleId}`);
            const eleNodeInfo = editor.getNodeFromId(eleId);

            if (eleNode) {
                const nodeData = editor.drawflow.drawflow[editor.module].data[eleId];
                const newPosX = nodeData.pos_x + dx;
                const newPosY = nodeData.pos_y + dy;

                eleNode.style.left = newPosX + "px";
                eleNode.style.top = newPosY + "px";

                if (editor.drawflow.drawflow[editor.module] &&
                    editor.drawflow.drawflow[editor.module].data &&
                    editor.drawflow.drawflow[editor.module].data[eleId]) {
                    editor.drawflow.drawflow[editor.module].data[eleId].pos_x = newPosX;
                    editor.drawflow.drawflow[editor.module].data[eleId].pos_y = newPosY;
                }

                editor.updateConnectionNodes(`node-${eleId}`);
            }

            if (eleNodeInfo.class && eleNodeInfo.class === "GROUP") {
                moveGroupNodes(eleId, dx, dy);
            }
        });
    }

    function collapseNode(nodeId) {
        const nodeElement = document.getElementById(`node-${nodeId}`);
        const contentBox = nodeElement.querySelector('.box');
        const toggleArrow = nodeElement.querySelector('.toggle-arrow');

        contentBox.classList.add('hidden');
        toggleArrow.textContent = "\u25BC";
    }


    editor.on("nodeMoved", (id) => {
        const dragNode = id;
        if (dragElementHover !== null) {
            const dropNode = dragElementHover.id.slice(5);
            if (dragNode !== dropNode) {
                removeOfGroupNode(dragNode);
                dragElementHover.classList.remove("hover-drop");
                const dropNodeInfo = editor.getNodeFromId(dropNode);
                const dropNodeInfoData = dropNodeInfo.data;
                if (dropNodeInfoData.elements.indexOf(dragNode) === -1) {
                    dropNodeInfoData.elements.push(dragNode);
                    editor.updateNodeDataFromId(dropNode, dropNodeInfoData);
                    // remove connections
                    editor.removeConnectionNodeId('node-' + id);
                    // Hide the ports when node is inside the group
                    togglePortsDisplay(dragNode, 'none');
                    const dragNodeData = editor.getNodeFromId(dragNode);
                    if (dragNodeData.class !== "GROUP") {
                        collapseNode(dragNode);
                    }
                }
            }
            dragElementHover = null;
        } else {
            // If the node is moved outside of any group, show the ports
            togglePortsDisplay(dragNode, '');
            removeOfGroupNode(dragNode);
        }
    })

    function togglePortsDisplay(nodeId, displayStyle) {
        const nodeElement = document.querySelector(`#node-${nodeId}`);
        if (nodeElement) {
            const inputs = nodeElement.querySelectorAll('.inputs .input');
            const outputs = nodeElement.querySelectorAll('.outputs .output');
            inputs.forEach(input => {
                input.style.display = displayStyle;
            });
            outputs.forEach(output => {
                output.style.display = displayStyle;
            });
        }
    }


    editor.on("nodeRemoved", (id) => {
        removeOfGroupNode(id);
    });

    function removeOfGroupNode(id) {
        Object.keys(editor.drawflow.drawflow[editor.module].data).forEach(ele => {
            if (editor.drawflow.drawflow[editor.module].data[ele].class === "GROUP") {
                const findIndex = editor.drawflow.drawflow[editor.module].data[ele].data.elements.indexOf(id);
                if (findIndex !== -1) {
                    editor.drawflow.drawflow[editor.module].data[ele].data.elements.splice(findIndex, 1);
                }
            }
        })
    }

    /* DRAG EVENT */

    /* Mouse and Touch Actions */

    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
        elements[i].addEventListener('touchend', drop, false);
        elements[i].addEventListener('touchmove', positionMobile, false);
        elements[i].addEventListener('touchstart', drag, false);
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;

    function positionMobile(ev) {
        mobile_last_move = ev;
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        if (ev.type === "touchstart") {
            mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
        } else {
            ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
        }
    }

    function drop(ev) {
        if (ev.type === "touchend") {
            var parentdrawflow = document.elementFromPoint(mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
            if (parentdrawflow != null) {
                addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
            }
            mobile_item_selec = '';
        } else {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("node");
            addNodeToDrawFlow(data, ev.clientX, ev.clientY);
        }

    }


    function addNodeToDrawFlow(name, pos_x, pos_y) {
        if (editor.editor_mode === 'fixed') {
            return false;
        }
        pos_x = pos_x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * (editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
        pos_y = pos_y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * (editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));


        switch (name) {
            // Workflow-Model
            case 'dashscope_chat':
                var dashscope_chat = `
        <div>
          <div class="title-box"><i class="fas fa-brain"></i> DashScope Chat
          <span class="toggle-arrow">&#x25B2;</span> </div>
          <div class="box">
            <div class="readme">DashScope Chat Configurations (Your API key will NOT be stored and exposed to the website
                maintainer)</div><br>
            <label> Config Name </label>
            <input type="text" df-args-config_name placeholder="qwen" data-required="true"><br>
            <label> Model Name</label>
            <input type="text" list="dashscope_chat-model-names" df-args-model_name data-required="true"><br>
            <datalist id="dashscope_chat-model-names">
              <option value="qwen-turbo">
              <option value="qwen-plus">
              <option value="qwen-max">
              <option value="qwen-max-1201">
            </datalist>
            <label> API key</label>
            <input type="text" df-args-api_key data-required="true"><br>
            <label> Temperature </label>
            <input type="number" df-args-temperature placeholder=0 min="0" max="2" step="0.1"><br>
            <label> Seed </label>
            <input type="number" df-args-seed placeholder=0 min="0">
          </div>
        </div>
        `;
                const dashscope_chatId = editor.addNode('dashscope_chat', 0, 0, pos_x,
                    pos_y,
                    'dashscope_chat', {
                        "args":
                            {
                                "config_name": '',
                                "model_name": '',
                                "api_key": '',
                                "temperature": 0.0,
                                "seed": 0,
                                "model_type": 'dashscope_chat',
                                "messages_key": 'input'
                            }
                    },
                    dashscope_chat);
                addEventListenersToNumberInputs(dashscope_chatId);
                break;

            case 'openai_chat':
                var openai_chat = `
        <div>
          <div class="title-box"><i class="fas fa-brain"></i> OpenAI Chat
          <span class="toggle-arrow">&#x25B2;</span></div>
          <div class="box">
            <div class="readme">OpenAI Chat Configurations (Your API key will NOT be stored and exposed to the website
                maintainer)</div><br>
            <label> Config Name </label>
            <input type="text" df-args-config_name placeholder="gpt" data-required="true"><br>
            <label> Model Name</label>
            <input type="text" list="openai_chat-model-names" df-args-model_name data-required="true"><br>
            <datalist id="openai_chat-model-names">
              <option value="gpt-4">
              <option value="gpt-3.5-turbo">
              <option value="gpt-4-1106-preview">
              <option value="gpt-4-vision-preview">
            </datalist>
            <label> API key</label>
            <input type="text" df-args-api_key data-required="true"><br>
            <label> Temperature </label>
            <input type="number" df-args-temperature placeholder=0 min="0" max="2" step="0.1"><br>
            <label> Seed </label>
            <input type="number" df-args-seed placeholder=0 min="0">
            <div class="advanced-title-box" onclick="toggleAdvanced()">Advanced &#x25BC;</div>
            <div class="advanced-box" style="display: none">
              <label>Base URL</label>
              <input type="text" df-args-client_args-base_url><br>
            </div>
          </div>
          </div>
        </div>
        `;
                const openai_chatId = editor.addNode('openai_chat', 0, 0, pos_x,
                    pos_y,
                    'openai_chat', {
                        "args":
                            {
                                "config_name": '',
                                "model_name": '',
                                "api_key": '',
                                "temperature": 0.0,
                                "seed": 0,
                                "model_type": 'openai_chat',
                                "messages_key": 'messages'
                            }
                    },
                    openai_chat);
                addEventListenersToNumberInputs(openai_chatId);
                break;

            case 'post_api_chat':
                var post_api_chat = `
        <div>
          <div class="title-box"><i class="fas fa-brain"></i> Post API Chat
                    <span class="toggle-arrow">&#x25B2;</span></div>
          <div class="box">
            <div class="readme">Post API Chat Configurations</div><br>
            <label> Config Name </label>
            <input type="text" df-args-config_name placeholder="post_chat" data-required="true"><br>
            <label> Model Name </label>
            <input type="text" df-args-json_args-model placeholder="gpt-4" data-required="true"><br>
            <label> Temperature </label>
            <input type="number" df-args-json_args-temperature placeholder=0 min="0" max="2" step="0.1"><br>
            <label> Seed </label>
            <input type="number" df-args-json_args-seed placeholder=0 min="0">
            <label> API url</label>
            <input type="text" df-args-api_url><br>
            <label> Content-Type </label>
            <input type="text" df-args-headers-content_type placeholder="application/json"><br>
            <label> Authorization </label>
            <input type="text" df-args-headers-authorization><br>
            <label> Messages Key </label>
            <input type="text" df-args-messages_key placeholder="messages"><br>
          </div>
        </div>
        `;
                const post_api_chatId = editor.addNode('post_api_chat', 0, 0, pos_x, pos_y,
                    'post_api_chat', {
                        "args":
                            {
                                "config_name": '',
                                "api_url": '',
                                "headers": {
                                    "content_type": 'application/json',
                                    "authorization": '',
                                },
                                "json_args": {
                                    "model": '',
                                    "temperature": 0.0,
                                    "seed": 0,
                                },
                                "model_type": 'post_api_chat',
                                "messages_key": 'messages'
                            }
                    },
                    post_api_chat);
                addEventListenersToNumberInputs(post_api_chatId);
                break;

            case 'post_api_dall_e':
                var post_api_dall_e = `
        <div>
          <div class="title-box"><i class="fas fa-brain"></i> Post API Dall-E
                    <span class="toggle-arrow">&#x25B2;</span></div>
          <div class="box">
            <div class="readme">Post API Dall-E Configurations</div><br>
            <label> Config Name </label>
            <input type="text" df-args-config_name placeholder="dall_e" data-required="true"><br>
            <label> Model Name </label>
            <input type="text" df-args-json_args-model placeholder="dall-e-3" data-required="true"><br>
            <label> Number of Images </label>
            <input type="number" df-args-json_args-n placeholder=1 data-required="true"><br>
            <label> size </label>
            <input type="text" list="dall_e-image-sizes" df-args-json_args-size data-required="true"><br>
            <datalist id="dall_e-image-sizes">
              <option value="1024x1024">
              <option value="1792x1024">
              <option value="1024x1792">
            </datalist>
            <label> Temperature </label>
            <input type="number" df-args-json_args-temperature placeholder=0 min="0" max="2" step="0.1"><br>
            <label> Seed </label>
            <input type="number" df-args-json_args-seed placeholder=0 min="0">
            <label> API url</label>
            <input type="text" df-args-api_url><br>
            <label> Content-Type </label>
            <input type="text" df-args-headers-content_type placeholder="application/json"><br>
            <label> Authorization </label>
            <input type="text" df-args-headers-authorization><br>
            <label> Messages Key </label>
            <input type="text" df-args-messages_key placeholder="prompt"><br>
          </div>
        </div>
        `;
                const post_api_dall_eId = editor.addNode('post_api_dall_e', 0,
                    0,
                    pos_x, pos_y,
                    'post_api_dall_e', {
                        "args":
                            {
                                "config_name": '',
                                "api_url": '',
                                "headers": {
                                    "content_type": 'application/json',
                                    "authorization": '',
                                },
                                "json_args": {
                                    "model": '',
                                    "n": 1,
                                    "size": "",
                                    "temperature": 0.0,
                                    "seed": 0,
                                },
                                "model_type": 'post_api_dall_e',
                                "messages_key": 'prompt'
                            }
                    },
                    post_api_dall_e);
                addEventListenersToNumberInputs(post_api_dall_eId);
                break;

            // Message
            case 'Message':
                var Message = `
          <div>
            <div class="title-box"><i class="fas fa-comment-dots"></i>Message
            <span class="toggle-arrow">&#x25B2;</div>
            <div class="box">
              <p>Name</p>
              <input type="text" df-args-name placeholder="Host" data-required="true"><br>
              <p>Content</p>
              <input type="text" df-args-content placeholder="Hello" data-required="true"><br>
              <p>URL (Optional)</p>
              <input type="text" df-args-url placeholder=""><br>
            </div>
          </div>
          `;
                const MessageID = editor.addNode('Message', 1, 1, pos_x,
                    pos_y, 'Message', {
                        "args":
                            {
                                "name": '',
                                "content": '',
                                "url": ''
                            }
                    }, Message);
                break;

            // Workflow-Agent
            case 'DialogAgent':
                var placeholderId = "ID_PLACEHOLDER";

                var DialogAgent = `
          <div>
            <div class="title-box"><i class="fas fa-robot"></i>DialogAgent
            <button class="button copy-button">Copy</button>
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
              <div class="readme">
              Agent for dialog
              <div>Node ID: <span class="node-id">${placeholderId}</span></div>
                </div>
              <p>Name</p>
              <input type="text" df-args-name placeholder="Assistant" data-required="true"><br>
              <p>System prompt</p>
              <input type="text" df-args-sys_prompt placeholder="You're an assistant." data-required="true"><br>
              <p>Model config name</p>
              <input type="text" df-args-model_config_name placeholder="gpt-3.5-turbo" data-required="true">
            </div>
          </div>
          `;
                const DialogAgentID = editor.addNode('DialogAgent', 1, 1,
                    pos_x,
                    pos_y,
                    'DialogAgent', {
                        "args": {
                            "name": '',
                            "sys_prompt": '',
                            "model_config_name": ''
                        }
                    }, DialogAgent);
                var nodeElement = document.querySelector(`#node-${DialogAgentID} .node-id`);
                if (nodeElement) {
                    nodeElement.textContent = DialogAgentID;
                }
                break;

            case 'UserAgent':
                var placeholderId = "ID_PLACEHOLDER";
                var UserAgent = `
          <div>
            <div class="title-box"><i class="fas fa-robot"></i>UserAgent
            <button class="button copy-button">Copy</button>
            <span class="toggle-arrow">&#x25B2;</div>
            <div class="box">
            <div class="readme">
            A proxy agent for user
            <div>Node ID: <span class="node-id">${placeholderId}</span></div>
            </div>
              <p>Name</p>
              <input type="text" df-args-name placeholder="User"><br>
            </div>
          </div>
          `;
                const UserAgentID = editor.addNode('UserAgent', 1, 1, pos_x,
                    pos_y, 'UserAgent', {
                        "args": {"name": 'User'}
                    }, UserAgent);
                var nodeElement = document.querySelector(`#node-${UserAgentID} .node-id`);
                if (nodeElement) {
                    nodeElement.textContent = UserAgentID;
                }
                break;
            case 'TextToImageAgent':
                var placeholderId = "ID_PLACEHOLDER";
                var TextToImageAgent = `
          <div>
            <div class="title-box"><i class="fas fa-robot"></i>TextToImageAgent
            <button class="button copy-button">Copy</button>
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">
            Agent for text to image generation
              <div>Node ID: <span class="node-id">${placeholderId}</span></div>
              </div>
              <p>Name</p>
              <input type="text" df-args-name placeholder="Assistant" data-required="true"><br>
              <p>Model config name</p>
              <input type="text" df-args-model_config_name placeholder="dall-e-3">
            </div>
          </div>
          `;
                const TextToImageAgentID =
                    editor.addNode('TextToImageAgent', 1,
                        1, pos_x, pos_y,
                        'TextToImageAgent', {
                            "args": {
                                "name": '',
                                "model_config_name": ''
                            }
                        }, TextToImageAgent);
                var nodeElement = document.querySelector(`#node-${TextToImageAgentID} .node-id`);
                if (nodeElement) {
                    nodeElement.textContent = TextToImageAgentID;
                }
                break;

            case 'DictDialogAgent':
                var placeholderId = "ID_PLACEHOLDER";
                var DictDialogAgent = `
          <div>
            <div class="title-box"><i class="fas fa-robot"></i>DictDialogAgent
                <button class="button copy-button">Copy</button>
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">
            Agent that generates response in a dict format
            <div>Node ID: <span class="node-id">${placeholderId}</span></div>
            </div>
              <p>Name</p>
              <input type="text" df-args-name placeholder="Assistant" data-required="true"><br>
              <p>System prompt</p>
              <input type="text" df-args-sys_prompt placeholder="You're an assistant." data-required="true"><br>
              <p>Model config name</p>
              <input type="text" df-args-model_config_name placeholder="gpt-4" data-required="true">
              <p>Max retries</p>
              <input type="number" df-args-max_retries placeholder=3 min="1">
              <p>Parse function (Optional)</p>
              <input type="text" df-args-parse_func>
              <p>Fault handler (Optional)</p>
              <input type="text" df-args-fault_handler>
            </div>
          </div>
          `;
                const DictDialogAgentID = editor.addNode('DictDialogAgent', 1,
                    1, pos_x, pos_y,
                    'DictDialogAgent', {
                        "args": {
                            "name": '',
                            "sys_prompt": '',
                            "model_config_name": '',
                            "parse_func": '',
                            "fault_handler": '',
                            "max_retries": 3,
                        }
                    }, DictDialogAgent);
                var nodeElement = document.querySelector(`#node-${DictDialogAgentID} .node-id`);
                if (nodeElement) {
                    nodeElement.textContent = DictDialogAgentID;
                }
                break;

            case 'ReActAgent':
                var placeholderId = "ID_PLACEHOLDER";
                var ReActAgent = `
          <div>
            <div class="title-box"><i class="fas fa-robot"></i>ReActAgent
            <button class="button copy-button">Copy</button>
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
              <div class="readme">
              Agent for ReAct (reasoning and acting) with tools
              <div>Node ID: <span class="node-id">${placeholderId}</span></div>
                </div>
              <p>Name</p>
              <input type="text" df-args-name placeholder="Assistant" data-required="true"><br>
              <p>System prompt</p>
              <input type="text" df-args-sys_prompt placeholder="You're an assistant."><br>
              <p>Model config name</p>
              <input type="text" df-args-model_config_name placeholder="gpt-3.5-turbo" data-required="true"><br>
              <p>Tools</p>
              <div class="tools-placeholder" data-required="true">Please drag and drop a Tool module into this area. Inserting other types of modules may result in errors.</div>
              <p>Max reasoning-acting iterations</p>
              <input type="number" df-args-max_iters placeholder=10 min=1 step=1>
              <p>Verbose</p>
              <input type="text" list="reactagent-verbose" df-args-verbose><br>
              <datalist id="reactagent-verbose">
              <option value="True">
              <option value="False">
              </datalist>
            </div>
          </div>
          `;
                const ReActAgentID = editor.addNode('ReActAgent', 1, 1, pos_x, pos_y,
                    'GROUP', {
                        elements: [],
                        "args": {
                            "name": '',
                            "sys_prompt": '',
                            "model_config_name": '',
                            "max_iters": 10,
                            "verbose": '',
                        }
                    }, ReActAgent);

                var nodeElement = document.querySelector(`#node-${ReActAgentID} .node-id`);
                if (nodeElement) {
                    nodeElement.textContent = ReActAgentID;
                }
                break;

            // Workflow-Pipeline
            case 'Placeholder':
                var Placeholder = `
          <div>
            <div class="title-box"><i class="fas fa-project-diagram"></i>Placeholder
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">A placeholder that do nothing</div>
            </div>
          </div>
          `;
                editor.addNode('Placeholder', 1, 1,
                    pos_x, pos_y, 'Placeholder', {}, Placeholder);
                break;

            case 'MsgHub':
                var MsgHub = `
          <div>
            <div class="title-box"><i class="fas fa-project-diagram"></i>MsgHub
                <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
                <div class="readme">MsgHub is used to share messages among a group of agents</div>
                <p>Announcement Name</p>
                <input type="text" df-args-announcement-name placeholder="Host" style="width: 450px"><br>
                <p>Announcement Content</p>
                <input type="text" df-args-announcement-content placeholder="Welcome to the group chat!" style="width: 450px"><br>
                <div class="placeholder"></div>
            </div>
          </div>
          `;
                editor.addNode('MsgHub', 1, 1, pos_x, pos_y,
                    'GROUP', {
                        elements: [],
                        "args": {
                            "announcement": {
                                "name": '',
                                "content": ''
                            }
                        }
                    }, MsgHub);
                break;

            case 'SequentialPipeline':
                var SequentialPipeline = `
          <div>
            <div class="title-box"><i class="fas fa-project-diagram"></i>SequentialPipeline
                <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
                <div class="readme">A template pipeline for implementing sequential logic (<b>from top to bottom</b>)</div>
                <div class="placeholder"></div>
            </div>
          </div>
          `;
                editor.addNode('SequentialPipeline', 1, 1, pos_x, pos_y,
                    'GROUP', {elements: []}, SequentialPipeline);
                break;

            case 'ForLoopPipeline':
                var ForLoopPipeline = `
          <div>
            <div class="title-box"><i class="fas fa-project-diagram"></i>ForLoopPipeline
                <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
                <div class="readme">A template pipeline for implementing control flow like for-loop</div>
                <p>Max Loop</p>
                <input type="number" df-args-max_loop placeholder=3 min="1" step="1" style="width: 450px">
                <p>Break Function</p>
                <input type="text" df-args-break_func style="width: 450px"><br>
                <div class="placeholder"></div>
            </div>
          </div>
          `;
                const ForLoopPipelineID =
                    editor.addNode('ForLoopPipeline', 1, 1, pos_x, pos_y,
                        'GROUP', {
                            elements: [],
                            "args": {
                                "max_loop": 3,
                                "break_func": ''
                            }
                        }, ForLoopPipeline);
                addEventListenersToNumberInputs(ForLoopPipelineID);
                break;

            case 'WhileLoopPipeline':
                var WhileLoopPipeline = `
          <div>
            <div class="title-box"><i class="fas fa-project-diagram"></i>WhileLoopPipeline
                <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
                <div class="readme">A template pipeline for implementing control flow like while-loop</div>
                <p>Condition Function</p>
                <input type="text" df-args-condition_func style="width: 450px"><br>
                <div class="placeholder"></div>
            </div>
          </div>
          `;
                editor.addNode('WhileLoopPipeline', 1, 1, pos_x, pos_y,
                    'GROUP', {
                        elements: [],
                        "args": {
                            "condition_func": ''
                        }
                    }, WhileLoopPipeline);
                break;

            case 'IfElsePipeline':
                var IfElsePipeline = `
                  <div>
                    <div class="title-box">
                      <i class="fas fa-code-branch"></i> IfElsePipeline
                      <span class="toggle-arrow">&#x25BC;</span>
                    </div>
                    <div class="box" style="height: 350px;">
                      <div class="readme">A template pipeline for implementing control flow with if-else logic</div>
                      <p>Condition Function</p>
                      <input type="text" df-args-condition_func><br>
                      <div class="if-placeholder"> If condition</div>
                      <div class="else-placeholder"> Else condition</div>
                    </div>
                  </div>
                `;
                editor.addNode('IfElsePipeline', 1,
                    1, pos_x, pos_y, 'GROUP', {
                        elements: [], args: {
                            "condition_func": ''
                        }
                    }, IfElsePipeline);
                break;

            case 'SwitchPipeline':
                var SwitchPipeline = `
                    <div>
                        <div class="title-box">
                            <i class="fas fa-code-branch"></i> SwitchPipeline
                            <span class="toggle-arrow">&#x25BC;</span>
                        </div>
                        <div class="box">
                            <div class="readme">A template pipeline for implementing control flow with switch-case logic</div>
                            <p>Condition Function</p>
                            <input type="text" df-args-condition_func><br>
                            <button class="button add-case">Add Case</button>
                            <button class="button remove-case">Remove Case</button>
                            <div class="case-container">
                                <!-- Case branches will be added here -->
                            </div>

                        </div>
                    </div>
                `;
                const SwitchPipelineID = editor.addNode('SwitchPipeline', 1, 1, pos_x, pos_y, 'GROUP', {
                    elements: [], args: {
                        "condition_func": '',
                        "cases": [],
                    }
                }, SwitchPipeline);
                setupSwitchPipelineListeners(SwitchPipelineID);
                const caseContainer = document.querySelector(`#node-${SwitchPipelineID} .case-container`);
                if (caseContainer) {
                    addDefaultCase(caseContainer);
                } else {
                    console.error(`Case container not found in node-${SwitchPipelineID}.`);
                }
                break;

            // Workflow-Service
            case 'BingSearchService':
                var BingSearchService = `
          <div>
            <div class="title-box"><i class="fas fa-hammer"></i>BingSearchService
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">Integrate the Bing Search service within ReActAgent to enhance agent capabilities</div>
            <label> API key</label>
            <input type="text" df-args-api_key><br>
            <label> Results Number </label>
            <input type="number" df-args-num_results placeholder=3 min=1 step=1>
            </div>
          </div>
          `;
                editor.addNode('BingSearchService', 0, 0,
                    pos_x, pos_y, 'BingSearchService', {
                        "args": {
                            "api_key": "",
                            "num_results": 3,
                        }
                    }, BingSearchService);
                break;

            case 'GoogleSearchService':
                var GoogleSearchService = `
          <div>
            <div class="title-box"><i class="fas fa-hammer"></i>GoogleSearchService
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">Integrate the Google Search service within ReActAgent to enhance agent capabilities</div>
            <label> API key</label>
            <input type="text" df-args-api_key><br>
            <label> CSE ID</label>
            <input type="text" df-args-cse_id><br>
            <label> Results Number </label>
            <input type="number" df-args-num_results placeholder=3 min=1 step=1>
            </div>
          </div>
          `;
                editor.addNode('GoogleSearchService', 0, 0,
                    pos_x, pos_y, 'GoogleSearchService', {
                        "args": {
                            "api_key": "",
                            "cse_id": "",
                            "num_results": 3,
                        }
                    }, GoogleSearchService);
                break;

            case 'PythonService':
                var PythonService = `
          <div>
            <div class="title-box"><i class="fas fa-hammer"></i>PythonService
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">Integrate the Python Interpreter within ReActAgent to enhance agent capabilities</div>
            </div>
          </div>
          `;
                editor.addNode('PythonService', 0, 0,
                    pos_x, pos_y, 'PythonService', {}, PythonService);
                break;

            case 'ReadTextService':
                var ReadTextService = `
          <div>
            <div class="title-box"><i class="fas fa-hammer"></i>ReadTextService
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">Integrate the Read Text service within ReActAgent to enhance agent capabilities</div>
            </div>
          </div>
          `;
                editor.addNode('ReadTextService', 0, 0,
                    pos_x, pos_y, 'ReadTextService', {}, ReadTextService);
                break;

            case 'WriteTextService':
                var WriteTextService = `
          <div>
            <div class="title-box"><i class="fas fa-hammer"></i>WriteTextService
                      <span class="toggle-arrow">&#x25B2;</span></div>
            <div class="box">
            <div class="readme">Integrate the Write Text Service within ReActAgent to enhance agent capabilities</div>
            </div>
          </div>
          `;
                editor.addNode('WriteTextService', 0, 0,
                    pos_x, pos_y, 'WriteTextService', {}, WriteTextService);
                break;


            default:
        }
    }

    function toggleAdvanced() {
        var advancedBox = document.querySelector('.advanced-box');
        if (advancedBox.style.display === "none") {
            advancedBox.style.display = "block";
        } else {
            advancedBox.style.display = "none";
        }
    }

    function handleInputChange(event) {
        const input = event.target;

        if (input.type === 'number') {
            const value = input.value;
            const floatValue = parseFloat(value);
            const nodeId = input.closest('.drawflow_content_node').parentElement.id.slice(5);

            if (!isNaN(floatValue)) {
                const node = editor.getNodeFromId(nodeId);
                const dataAttributes =
                    Array.from(input.attributes).filter(attr =>
                        attr.name.startsWith('df-args-'));
                dataAttributes.forEach(attr => {
                    const attrName = attr.name;
                    if (attrName.startsWith('df-args-json_args-')) {
                        const dataAttribute = attrName.substring(18)
                        if
                        (node.data.args.json_args.hasOwnProperty(dataAttribute)) {
                            node.data.args.json_args[dataAttribute] = floatValue;
                            editor.updateNodeDataFromId(nodeId, node.data);
                        }
                    } else {
                        const dataAttribute = attrName.substring(8);
                        if (node.data.args.hasOwnProperty(dataAttribute)) {
                            node.data.args[dataAttribute] = floatValue;
                            editor.updateNodeDataFromId(nodeId, node.data);
                        }
                    }
                });
            } else {
                console.error("Invalid input value:", value);
            }
        }
    }

    function addEventListenersToNumberInputs(nodeId) {
        const nodeElement = document.getElementById(`node-${nodeId}`);
        if (nodeElement) {
            const numberInputs = nodeElement.querySelectorAll('input[type=number]');
            numberInputs.forEach(input => {
                input.addEventListener('change', handleInputChange);
            });
        }
    }

    function validateTemperature(input) {
        const value = input.valueAsNumber;
        if (isNaN(value) || value < 0 || value >= 2) {
            input.setCustomValidity('Temperature must be greater or equal than 0 and less than 2!');
        } else {
            input.setCustomValidity('');
        }
        input.reportValidity();
    }

    function validateSeed(input) {
        const value = parseInt(input.value, 10); // Parse the value as an integer.
        if (isNaN(value) || value < 0 || !Number.isInteger(parseFloat(input.value))) {
            input.setCustomValidity('Seed must be a non-negative integer!');
        } else {
            input.setCustomValidity('');
        }
        input.reportValidity();
    }

    document.addEventListener('input', function (event) {
        const input = event.target;

        if (input.getAttribute('df-args-temperature') !== null ||
            input.getAttribute('df-args-json_args-temperature') !== null) {
            validateTemperature(input);
        }

        if (input.getAttribute('df-args-seed') !== null ||
            input.getAttribute('df-args-json_args-seed') !== null) {
            validateSeed(input);
        }
    });

    var transform = '';

    function showpopup(e) {
        e.target.closest(".drawflow-node").style.zIndex = "9999";
        e.target.children[0].style.display = "block";
        //document.getElementById("modalfix").style.display = "block";

        //e.target.children[0].style.transform = 'translate('+translate.x+'px, '+translate.y+'px)';
        transform = editor.precanvas.style.transform;
        editor.precanvas.style.transform = '';
        editor.precanvas.style.left = editor.canvas_x + 'px';
        editor.precanvas.style.top = editor.canvas_y + 'px';
        console.log(transform);

        //e.target.children[0].style.top  =  -editor.canvas_y - editor.container.offsetTop +'px';
        //e.target.children[0].style.left  =  -editor.canvas_x  - editor.container.offsetLeft +'px';
        editor.editor_mode = "fixed";

    }

    function updateReadmeAndTrimExtrasInHTML(htmlString, nodeId) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const containerDiv = doc.body.firstChild;

        removeNonReadmeChildren(containerDiv);
        updateReadmeContent(containerDiv, nodeId);

        return containerDiv.innerHTML;
    }

    function updateReadmeContent(containerDiv, nodeId) {
        const readmeDiv = containerDiv.querySelector('.readme');
        if (readmeDiv) {
            console.log("readmeDiv", readmeDiv);

            let newDiv = document.createElement('div');
            newDiv.innerHTML = `Copy from Node ID: ${nodeId}`;
            readmeDiv.appendChild(newDiv);

            console.log("readmeDiv after", readmeDiv);
        }
    }

    function removeNonReadmeChildren(containerDiv) {
        const boxDiv = containerDiv.querySelector('.box');
        if (boxDiv) {
            boxDiv.querySelectorAll('*:not(.readme)').forEach(child => child.remove());
        }
    }

    function createNodeHTML(node, isCopy, originalNodeId) {
        let modifiedHtml = isCopy ? processNodeCopyHTML(node.html) : node.html;
        return updateReadmeAndTrimExtrasInHTML(modifiedHtml, originalNodeId);
    }

    function processNodeCopyHTML(htmlString) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');

        ['.copy-button', 'div .node-id'].forEach(selector => {
            const element = doc.querySelector(selector);
            if (element) element.remove();
        });

        return doc.body.innerHTML;
    }

    function copyNode(originalNodeId) {
        const originalNode = editor.getNodeFromId(originalNodeId);
        originalNode.data.copies = originalNode.data.copies || [];

        const newNodeHTML = createNodeHTML(originalNode, true, originalNodeId);
        const [posX, posY] = [originalNode.pos_x + 30, originalNode.pos_y + 30];

        editor.addNode("CopyNode",
            Object.keys(originalNode.inputs).length,
            Object.keys(originalNode.outputs).length,
            posX, posY, 'node-' + originalNode.name, {elements: [originalNodeId.toString()]},
            newNodeHTML);
    }

    function setupNodeCopyListens(nodeId) {
        const newNode = document.getElementById(`node-${nodeId}`);
        if (newNode) {
            const copyButton = newNode.querySelector('.copy-button');
            if (copyButton) {
                copyButton.addEventListener('click', function () {
                    copyNode(nodeId);
                });
            }
        }
    }

    function hideShowGroupNodes(groupId, show) {
        const groupInfo = editor.getNodeFromId(groupId);
        if (groupInfo && groupInfo.class === 'GROUP') {
            groupInfo.data.elements.forEach(elementNodeId => {
                const elementNode = document.getElementById(`node-${elementNodeId}`);
                const childNodeInfo = editor.getNodeFromId(elementNodeId);
                if (elementNode) {
                    elementNode.style.display = show ? '' : 'none';
                }
                if (childNodeInfo.class === 'GROUP') {
                    hideShowGroupNodes(elementNodeId, show);
                }
            });
        }
    }

    function setupNodeListeners(nodeId) {
        const newNode = document.getElementById(`node-${nodeId}`);
        if (newNode) {

            const titleBox = newNode.querySelector('.title-box');
            const contentBox = newNode.querySelector('.box') ||
                newNode.querySelector('.box-highlight');
            const resizeHandleSE = document.createElement('div');
            resizeHandleSE.className = 'resize-handle-se';
            contentBox.appendChild(resizeHandleSE);

            const toggleArrow = newNode.querySelector('.toggle-arrow');

            if (toggleArrow && contentBox && titleBox) {
                toggleArrow.addEventListener('click', function () {
                    console.log("Arrow clicked");
                    console.log("toggleArrow", toggleArrow);
                    console.log("contentBox", contentBox);
                    console.log("contentBox.classList", contentBox.classList);
                    contentBox.classList.toggle('hidden');

                    if (contentBox.classList.contains('hidden')) {
                        toggleArrow.textContent = "\u25BC";
                        hideShowGroupNodes(nodeId, false);
                    } else {
                        toggleArrow.textContent = "\u25B2";
                        hideShowGroupNodes(nodeId, true);
                    }
                    editor.updateConnectionNodes('node-' + nodeId);
                });

                let startX, startY, startWidth, startHeight;

                resizeHandleSE.addEventListener('mousedown', function (e) {
                    e.stopPropagation();
                    document.addEventListener('mousemove', doDragSE, false);
                    document.addEventListener('mouseup', stopDragSE, false);

                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = parseInt(document.defaultView.getComputedStyle(contentBox).width, 10);
                    startHeight = parseInt(document.defaultView.getComputedStyle(contentBox).height, 10);
                });

                function doDragSE(e) {
                    newNode.style.width = 'auto';
                    const newWidth = (startWidth + e.clientX - startX) + 'px';
                    contentBox.style.width = newWidth;
                    titleBox.style.width = newWidth;
                    const newHeight = (startHeight + e.clientY - startY) + 'px';
                    contentBox.style.height = newHeight;

                    editor.updateConnectionNodes('node-' + nodeId);
                }

                function stopDragSE(e) {
                    document.removeEventListener('mousemove', doDragSE, false);
                    document.removeEventListener('mouseup', stopDragSE, false);
                }

            }
        }
    }

    function setupSwitchPipelineListeners(nodeId) {
        const newNode = document.getElementById(`node-${nodeId}`);
        if (!newNode) {
            console.error(`Node with ID node-${nodeId} not found.`);
            return;
        }
        const addCaseButton = newNode.querySelector('.add-case');
        if (!addCaseButton) {
            console.error(`Add Case button not found in node-${nodeId}.`);
            return;
        }
        addCaseButton.addEventListener('click', function () {
            var caseContainer = newNode.querySelector('.case-container');
            if (!caseContainer) {
                console.error(`Case container not found in node-${nodeId}.`);
                return;
            }
            var defaultCaseElement = caseContainer.querySelector('.default-case');
            if (defaultCaseElement) {
                caseContainer.removeChild(defaultCaseElement);
            }
            var caseCount = caseContainer.getElementsByClassName('case-placeholder').length;
            var caseElement = document.createElement('div');
            caseElement.classList.add('case-placeholder');

            var caseText = document.createTextNode(`Case ${caseCount + 1}: `);
            caseElement.appendChild(caseText);

            var inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.placeholder = `Case Pattern`;

            inputElement.dataset.caseIndex = caseCount;

            caseElement.appendChild(inputElement);
            caseContainer.appendChild(caseElement);

            inputElement.addEventListener('input', function (e) {
                var nodeData = editor.getNodeFromId(nodeId).data;
                console.log("nodeData", nodeData);
                var index = e.target.dataset.caseIndex;
                console.log("index", index);
                nodeData.args.cases[index] = e.target.value;
                editor.updateNodeDataFromId(nodeId, nodeData);
            });

            editor.getNodeFromId(nodeId).data.args.cases.push('');

            addDefaultCase(caseContainer);
            editor.updateConnectionNodes('node-' + nodeId);
        });

        const removeCaseButton = newNode.querySelector('.remove-case');
        if (!removeCaseButton) {
            console.error(`Remove Case button not found in node-${nodeId}.`);
            return;
        }
        removeCaseButton.addEventListener('click', function () {
            var caseContainer = newNode.querySelector('.case-container');
            var cases = caseContainer.getElementsByClassName('case-placeholder');
            if (cases.length > 1) {
                caseContainer.removeChild(cases[cases.length - 2]);
                var nodeData = editor.getNodeFromId(nodeId).data;
                nodeData.args.cases.splice(nodeData.args.cases.length - 1, 1);
                editor.updateNodeDataFromId(nodeId, nodeData);
            }
            editor.updateConnectionNodes('node-' + nodeId);
        });
    }

    function addDefaultCase(caseContainer) {
        var defaultCaseElement = document.createElement('div');
        defaultCaseElement.classList.add('case-placeholder', 'default-case');
        defaultCaseElement.textContent = `Default Case`;
        caseContainer.appendChild(defaultCaseElement);
    }

    function closemodal(e) {
        e.target.closest(".drawflow-node").style.zIndex = "2";
        e.target.parentElement.parentElement.style.display = "none";
        //document.getElementById("modalfix").style.display = "none";
        editor.precanvas.style.transform = transform;
        editor.precanvas.style.left = '0px';
        editor.precanvas.style.top = '0px';
        editor.editor_mode = "edit";
    }

    function changeModule(event) {
        var all = document.querySelectorAll(".menu ul li");
        for (var i = 0; i < all.length; i++) {
            all[i].classList.remove('selected');
        }
        event.target.classList.add('selected');
    }

    function changeMode(option) {
        if (option == 'lock') {
            lock.style.display = 'none';
            unlock.style.display = 'block';
        } else {
            lock.style.display = 'block';
            unlock.style.display = 'none';
        }

    }

    function toggleDraggable(element) {
        var content = element.nextElementSibling;
        if (content.classList.contains('visible')) {
            content.classList.remove('visible');
        } else {
            content.classList.add('visible');
        }
    }

    function filterEmptyValues(obj) {
        return Object.entries(obj).reduce((acc, [key, value]) => {
            if (typeof value === 'object' && value !== null) {
                const filteredNestedObj = filterEmptyValues(value);
                if (Object.keys(filteredNestedObj).length > 0) {
                    acc[key] = filteredNestedObj;
                }
            } else if (value !== '') {
                acc[key] = value;
            }
            return acc;
        }, {});
    }

    // This function is the most important to AgentScope config.
    function reorganizeAndFilterConfigForAgentScope(inputData) {
        // Assuming there's only one tab ('Home'), but adjust if there are more
        const homeTab = inputData.drawflow.Home;
        // Create a new object to hold the reorganized and filtered nodes
        const filteredNodes = {};

        // Iterate through the nodes and copy them to the filteredNodes object
        Object.entries(homeTab.data).forEach(([key, node]) => {
            // Skip the node if the name is 'welcome' or 'readme'
            const nodeName = node.name.toLowerCase();
            if (nodeName === 'welcome' || nodeName === 'readme') {
                return;
            }

            // Create a copy of the node without 'html', 'typenode', 'class', 'id', and 'name' fields
            const {
                html,
                typenode,
                pos_x,
                pos_y,
                class: classField,
                id,
                ...cleanNode
            } = node;

            if (cleanNode.data && cleanNode.data.args) {
                cleanNode.data.args = filterEmptyValues(cleanNode.data.args);
            }

            // Add the cleaned node to the filteredNodes object using its id as the key
            filteredNodes[key] = cleanNode;
        });

        // Return the filtered and reorganized nodes instead of the original structure
        return filteredNodes;
    }


    function sortElementsByPosition(inputData) {
        let hasError = false;

        Object.keys(inputData.drawflow).forEach((moduleKey) => {
            const moduleData = inputData.drawflow[moduleKey];
            Object.entries(moduleData.data).forEach(([nodeId, node]) => {
                if (node.class === 'GROUP') {
                    let elements = node.data.elements;
                    let elementsWithPosition = elements.map(elementId => {
                        const elementNode = document.querySelector(`#node-${elementId}`);
                        return elementNode ? {
                            id: elementId,
                            position: {
                                x: elementNode.style.left,
                                y: elementNode.style.top
                            }
                        } : null;
                    }).filter(el => el);

                    try {
                        elementsWithPosition.sort((a, b) => {
                            let y1 = parseInt(a.position.y, 10);
                            let y2 = parseInt(b.position.y, 10);
                            if (y1 === y2) {
                                throw new Error(`Two elements have the same y position: Element ${a.id} and Element ${b.id}`);
                            }
                            return y1 - y2;
                        });
                    } catch (error) {
                        alert(error.message);
                        hasError = true;
                    }
                    node.data.elements = elementsWithPosition.map(el => el.id);
                }
            });
        });
        return hasError;
    }

    function checkConditions() {
        let hasModelTypeError = true;
        let hasAgentError = true;
        let agentModelConfigNames = new Set();
        let modelConfigNames = new Set();
        let isApiKeyEmpty = false;
        const nodesData = editor.export().drawflow.Home.data;

        for (let nodeId in nodesData) {
            let node = nodesData[nodeId];
            console.log("node", node);
            console.log("node.inputs", node.inputs);


            if (node.inputs) {
                for (let inputKey in node.inputs) {
                    if (node.inputs[inputKey].connections &&
                        node.inputs[inputKey].connections.length > 1) {
                        Swal.fire({
                            title: 'Invalid Connections',
                            text:
                                `${node.name} has more than one connection in inputs.`,
                            icon: 'error',
                            confirmButtonText: 'Ok'
                        });
                        return false;
                    }
                }
            }

            if (node.outputs) {
                for (let outputKey in node.outputs) {
                    if (node.outputs[outputKey].connections &&
                        node.outputs[outputKey].connections.length > 1) {
                        Swal.fire({
                            title: 'Invalid Connections',
                            text:
                                `${node.name} has more than one connection in outputs.`,
                            icon: 'error',
                            confirmButtonText: 'Ok'
                        });
                        return false;
                    }
                }
            }

            let nodeElement = document.getElementById('node-' + nodeId);
            const requiredInputs = nodeElement.querySelectorAll('input[data-required="true"]');

            let titleBox = nodeElement.querySelector('.title-box');

            let titleText = '';
            for (const child of titleBox.childNodes) {
                if (child.nodeType === Node.TEXT_NODE) {
                    titleText += child.textContent.trim();
                }
            }

            for (const input of requiredInputs) {
                if (input.value.trim() === '') {
                    let inputLabel = input.previousElementSibling;
                    if (inputLabel && inputLabel.tagName.toLowerCase() === "label") {
                        let labelText = inputLabel.textContent.trim();

                        Swal.fire({
                            title: 'Value Missing!',
                            text: `${labelText} is missing in ${titleText}.`,
                            icon: 'error',
                            confirmButtonText: 'Ok'
                        });
                        return false;
                    }
                }
            }

            if (node.data && node.data.args && node.data.args.model_type) {
                hasModelTypeError = false;
                modelConfigNames.add(node.data.args.config_name);
                if (node.data.args.api_key === "") {
                    isApiKeyEmpty = isApiKeyEmpty || true;
                }
            }
            if (node.name.includes('Agent') && "model_config_name" in node.data.args) {
                hasAgentError = false;
                if (node.data && node.data.args) {
                    agentModelConfigNames.add(node.data.args.model_config_name);
                }
            }
            if (node.name === 'ReActAgent') {
                const elements = node.data.elements;
                for (const nodeId of elements) {
                    const childNode = nodesData[nodeId]
                    if (!childNode || !childNode.name.includes('Service')) {
                        Swal.fire({
                            title: 'Invalid ReActAgent Configuration',
                            text:
                                `ReActAgent must only contain Tool nodes as child nodes.`,
                            icon: 'error',
                            confirmButtonText: 'Ok'
                        });
                        return false;
                    }
                }
            }
            if (node.name === 'IfElsePipeline') {
                const elementsSize = node.data.elements.length;
                if (elementsSize !== 1 && elementsSize !== 2) {
                    Swal.fire({
                        title: 'Invalid IfElsePipeline Configuration',
                        text: `IfElsePipeline should have 1 or 2 elements, but has ${elementsSize}.`,
                        icon: 'error',
                        confirmButtonText: 'Ok'
                    });
                    return false;
                }
            }
            if (['ForLoopPipeline', 'WhileLoopPipeline', 'MsgHub'].includes(node.name)) {
                if (node.data.elements.length !== 1) {
                    hasError = true;
                    Swal.fire({
                        title: 'Invalid Configuration',
                        text: `${node.name} must have exactly one element.`,
                        icon: 'error',
                        confirmButtonText: 'Ok'
                    });
                    return false;
                }
                let childNodeId = node.data.elements[0];
                let childNode = nodesData[childNodeId];
                if (!childNode || !childNode.name.includes('Pipeline')) {
                    Swal.fire({
                        title: 'Invalid Configuration',
                        text:
                            ` ${childNode.name} contained in ${node.name} is not a Pipeline node.`,
                        icon: 'error',
                        confirmButtonText: 'Ok'
                    });
                    return false;
                }
            }
        }

        let unmatchedConfigNames = [...agentModelConfigNames].filter(name => !modelConfigNames.has(name));
        console.log("modelConfigNames", modelConfigNames);
        console.log("agentModelConfigNames", agentModelConfigNames);
        console.log("unmatchedConfigNames", unmatchedConfigNames);
        if (hasModelTypeError) {
            Swal.fire({
                title: 'Error!',
                text:
                    'Error: At least one Model node must be present.',
                icon: 'error',
                confirmButtonText: 'Ok'
            });
        } else if (hasAgentError) {
            Swal.fire({
                title: 'No Agent Nodes Found',
                text: "Error: At least one Agent node must be present.",
                icon: 'error',
                confirmButtonText: 'Ok'
            });
        } else if (unmatchedConfigNames.length > 0) {
            Swal.fire({
                title: 'Configuration Mismatch',
                html:
                    "Each Agent's 'Model config name' must match a Model node's 'Config Name'.<br> Unmatched: " + unmatchedConfigNames.join(', '),
                icon: 'error',
                confirmButtonText: 'Ok'
            });
        } else if (isApiKeyEmpty) {
            Swal.fire({
                title: 'API KEY Missing',
                text:
                    "API KEY is missing in your model nodes. Please either enter the API KEY in the corresponding position, or enter a random bit of content and replace it with the real value in the exported files.",
                icon: 'error',
                confirmButtonText: 'Ok'
            });
        } else {
            return true;
        }
    }

    function showCheckPopup() {
        var btnCovers = document.querySelectorAll('.btn-cover');
        if (checkConditions()) {
            Swal.fire({
                title: 'Validation Success',
                text: "All checks are passed!",
                icon: 'success',
                confirmButtonText: 'Great!'
            });
            btnCovers.forEach(function (btnCover) {
                var button = btnCover.querySelector('.btn-disabled');
                if (button) {
                    button.classList.remove('btn-disabled');
                }
                btnCover.removeAttribute('data-title');
            });
        }
    }

    function disableButtons() {
        var btnCovers = document.querySelectorAll('.btn-cover');

        btnCovers.forEach(function (btnCover) {
            var button = btnCover.querySelector('div');
            if (button) {
                button.classList.add('btn-disabled');
            }
            btnCover.setAttribute('data-title',
                'Please click the "Check" button first.');
        });
    }


    function showExportConfigPopup() {
        const rawData = editor.export();

        const hasError = sortElementsByPosition(rawData);
        if (hasError) {
            return;
        }

        const filteredData = reorganizeAndFilterConfigForAgentScope(rawData);
        const exportData = JSON.stringify(filteredData, null, 4);

        Swal.fire({
            title: '<b>Workflow Configuration</b>',
            html:
                '<p>Save as config.json <br>' +
                'Then run the following command in your terminal:<br>' +
                '<div class="code-snippet">as_workflow config.json</div><br>' +
                ' or <div class="code-snippet">as_studio config.json</div></p>' +
                '<pre class="line-numbers"><code class="language-javascript" id="export-data">'
                + exportData +
                '</code></pre>',
            showCloseButton: true,
            showCancelButton: true,
            confirmButtonText: 'Copy',
            cancelButtonText: 'Close',
            onBeforeOpen: (element) => {
                // Find the code element inside the Swal content
                const codeElement = element.querySelector('code');

                // Now highlight the code element with Prism
                Prism.highlightElement(codeElement);

                // Copy to clipboard logic
                const content = codeElement.textContent;
                const copyButton = Swal.getConfirmButton();
                copyButton.addEventListener('click', () => {
                    copyToClipboard(content);
                });
            }
        });
    }

    function showExportPyPopup() {
        const rawData = editor.export();

        const hasError = sortElementsByPosition(rawData);
        if (hasError) {
            return;
        }

        const filteredData = reorganizeAndFilterConfigForAgentScope(rawData);

        Swal.fire({
            title: 'Processing...',
            text: 'Please wait.',
            allowOutsideClick: false,
            onBeforeOpen: () => {
                Swal.showLoading()
            }
        });

        fetch('/convert-to-py', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: JSON.stringify(filteredData, null, 4),
            })
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network error.');
            }
            return response.json();
        })
            .then(data => {
                Swal.close();
                if (data.is_success === 'True') {
                    Swal.fire({
                        title: '<b>Workflow Python Code</b>',
                        html:
                            '<p>Save as main.py<br>' +
                            'Then run the following command in your terminal:<br>' +
                            '<div class="code-snippet">python main.py</div><br>' +
                            'or <div class="code-snippet">as_studio main.py</div></p>' +
                            '<pre class="line-numbers"><code class="language-py" id="export-data">' +
                            data.py_code +
                            '</code></pre>',
                        showCloseButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'Copy',
                        cancelButtonText: 'Close',
                        onBeforeOpen: (element) => {
                            const codeElement = element.querySelector('code');
                            Prism.highlightElement(codeElement);
                            const copyButton = Swal.getConfirmButton();
                            copyButton.addEventListener('click', () => {
                                copyToClipboard(codeElement.textContent);
                            });
                        }
                    });
                } else {
                    const errorMessage = `
            <p>An error occurred during the Python code generation process. Please check the following error:</p>
            <pre class="line-numbers"><code class="language-py">${data.py_code}</code></pre>
        `;
                    Swal.fire({
                        title: 'Error!',
                        html: errorMessage,
                        icon: 'error',
                        customClass: {
                            popup: 'error-popup'
                        },
                        confirmButtonText: 'Close',
                        onBeforeOpen: (element) => {
                            const codeElement = element.querySelector('code');
                            Prism.highlightElement(codeElement);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Failed!',
                    'There was an error generating your code.',
                    'error');
            });
    }

    function showExportRunPopup() {
        const rawData = editor.export();
        const hasError = sortElementsByPosition(rawData);
        if (hasError) {
            return;
        }
        const filteredData = reorganizeAndFilterConfigForAgentScope(rawData);

        Swal.fire({
            title: 'Processing...',
            text: 'Please wait.',
            allowOutsideClick: false,
            onBeforeOpen: () => {
                Swal.showLoading()
            }
        });

        fetch('/convert-to-py-and-run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: JSON.stringify(filteredData, null, 4),
            })
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network error.');
            }
            return response.json();
        })
            .then(data => {
                Swal.close();
                if (data.is_success === 'True') {
                    Swal.fire({
                        title: '<b>Application Running in Background</b>',
                        html:
                            '<p>Your application has been successfully run ' +
                            'in background.<br>' +
                            '<p><strong>Task UID:</strong>' +
                            data.uid + '</p>' +
                            '<pre class="line-numbers"><code class="language-py" id="export-data">' +
                            data.py_code +
                            '</code></pre>',
                        showCloseButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'Copy Code',
                        cancelButtonText: 'Close',
                        onBeforeOpen: (element) => {
                            const codeElement = element.querySelector('code');
                            Prism.highlightElement(codeElement);
                            const copyButton = Swal.getConfirmButton();
                            copyButton.addEventListener('click', () => {
                                copyToClipboard(codeElement.textContent);
                            });
                        }
                    });
                } else {
                    const errorMessage = `
        <p>An error occurred during the Python code running process. Please check the following error:</p>
        <pre class="line-numbers"><code class="language-py">${data.py_code}</code></pre>
    `;
                    Swal.fire({
                        title: 'Error!',
                        html: errorMessage,
                        icon: 'error',
                        customClass: {
                            popup: 'error-popup'
                        },
                        confirmButtonText: 'Close',
                        onBeforeOpen: (element) => {
                            const codeElement = element.querySelector('code');
                            Prism.highlightElement(codeElement);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.close();
                Swal.fire('Failed!',
                    'There was an error running your workflow.',
                    'error');
            });
    }


    function showExportHTMLPopup() {
        const rawData = editor.export();

        Object.keys(rawData.drawflow.Home.data).forEach((nodeId) => {
            const node = rawData.drawflow.Home.data[nodeId];
            const idPlaceholderRegex = /ID_PLACEHOLDER/g;
            node.html = node.html.replace(idPlaceholderRegex, nodeId);
        });

        const exportData = JSON.stringify(rawData, null, 4);

        const escapedExportData = exportData
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');

        Swal.fire({
            title: '<b>Workflow HTML</b>',
            html:
                '<p>This is used for generating HTML code, not for running.<br>' +
                '<pre class="line-numbers"><code class="language-javascript" id="export-data">'
                + escapedExportData +
                '</code></pre>',
            showCloseButton: true,
            showCancelButton: true,
            confirmButtonText: 'Copy',
            cancelButtonText: 'Close',
            onBeforeOpen: (element) => {
                // Find the code element inside the Swal content
                const codeElement = element.querySelector('code');

                // Now highlight the code element with Prism
                Prism.highlightElement(codeElement);

                // Copy to clipboard logic
                const content = codeElement.textContent;
                const copyButton = Swal.getConfirmButton();
                copyButton.addEventListener('click', () => {
                    copyToClipboard(content);
                });
            }
        });
    }


    function isValidDataStructure(data) {
        if (
            data.hasOwnProperty('drawflow') &&
            data.drawflow.hasOwnProperty('Home') &&
            data.drawflow.Home.hasOwnProperty('data')
        ) {

            for (const nodeId in data.drawflow.Home.data) {
                const node = data.drawflow.Home.data[nodeId];

                if (
                    !node.hasOwnProperty('id') ||
                    typeof node.id !== 'number' ||
                    !node.hasOwnProperty('name') ||
                    typeof node.name !== 'string' ||
                    !node.hasOwnProperty('class') ||
                    typeof node.class !== 'string' ||
                    !node.hasOwnProperty('html') ||
                    typeof node.html !== 'string'
                ) {
                    return false;
                }
            }
            return true;
        }
        return false;
    }


    function showImportHTMLPopup() {
        Swal.fire({
            title: 'Import Workflow Data',
            html:
                "<p>Please paste your HTML data below. Ensure that the source of the HTML data is trusted, as importing HTML from unknown or untrusted sources may pose security risks.</p>",
            input: 'textarea',
            inputLabel: 'Paste your HTML data here:',
            inputPlaceholder:
                'Paste your HTML data generated from `Export HTML` button...',
            inputAttributes: {
                'aria-label': 'Paste your HTML data here',
                'class': 'code'
            },
            customClass: {
                input: 'code'
            },
            showCancelButton: true,
            confirmButtonText: 'Import',
            cancelButtonText: 'Cancel',
            inputValidator: (value) => {
                if (!value) {
                    return 'You need to paste code generated from `Export HTML` button!';
                }
                try {
                    const parsedData = JSON.parse(value);
                    if (isValidDataStructure(parsedData)) {

                    } else {
                        return 'The data is invalid. Please check your data and try again.';
                    }
                } catch (e) {
                    return 'Invalid data! You need to paste code generated from `Export HTML` button!';
                }
            },
            preConfirm: (data) => {
                try {
                    const parsedData = JSON.parse(data);
                    editor.clear();
                    editor.import(parsedData);
                    importSetupNodes(parsedData);
                    Swal.fire('Imported!', '', 'success');
                } catch (error) {
                    Swal.showValidationMessage(`Import error: ${error}`);
                }
            }
        });
    }

    function importSetupNodes(dataToImport) {
        Object.keys(dataToImport.drawflow.Home.data).forEach((nodeId) => {
            setupNodeListeners(nodeId);

            const nodeElement = document.getElementById(`node-${nodeId}`);
            if (nodeElement) {
                const copyButton = nodeElement.querySelector('.button.copy-button');
                if (copyButton) {
                    setupNodeCopyListens(nodeId);
                }
            }
        });
    }

    function copyToClipboard(contentToCopy) {
        var tempTextarea = document.createElement("textarea");
        tempTextarea.value = contentToCopy;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        tempTextarea.setSelectionRange(0, 99999);

        try {
            var successful = document.execCommand("copy");
            if (successful) {
                Swal.fire('Copied!', '', 'success');
            } else {
                Swal.fire('Failed to copy', '', 'error');
            }
        } catch (err) {
            Swal.fire('Failed to copy', '', 'error');
        }
        document.body.removeChild(tempTextarea);
    }

    function fetchExample(index, processData) {
        fetch('/read-examples', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: index,
                lang: getCookie('locale') || 'en'
            })
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network error.');
            }
            return response.json();
        })
            .then(processData);
    }

    function importExample(index) {
        fetchExample(index, data => {
            const dataToImport = data.json;
            clearModuleSelected();
            editor.import(dataToImport);
            Object.keys(dataToImport.drawflow.Home.data).forEach((nodeId) => {
                setupNodeListeners(nodeId);
                const nodeElement = document.getElementById(`node-${nodeId}`);
                if (nodeElement) {
                    const copyButton = nodeElement.querySelector('.button.copy-button');
                    if (copyButton) {
                        setupNodeCopyListens(nodeId);
                    }
                }
            });
        })
    }

    function importExample_step(index) {
        fetchExample(index, data => {
            const dataToImportStep = data.json;
            clearModuleSelected();
            descriptionStep = ["Readme", "Model", "UserAgent",
                "DialogAgent"];
            initializeImport(dataToImportStep);
        })
    }

    let importQueue = [];
    let dataToImportStep;
    let currentImportIndex = 0;
    let accumulatedImportData = {};
    let descriptionStep = [];
    console.log("importQueue", importQueue)

    function updateImportButtons() {
        document.getElementById('import-prev').disabled = currentImportIndex
            <= 1;
        document.getElementById('import-next').disabled = currentImportIndex >= importQueue.length;
        document.getElementById('import-skip').disabled = currentImportIndex >= importQueue.length;
    }

    function createElement(tag, id, html = '', parent = document.body) {
        let element = document.getElementById(id) || document.createElement(tag);
        element.id = id;
        element.innerHTML = html;
        if (!element.parentNode) {
            parent.appendChild(element);
        }
        return element;
    }

    function initializeImport(data) {
        ['buttons-container', 'buttons-container-html'].forEach(cls => {
            let containers = document.getElementsByClassName(cls);
            Array.from(containers).forEach(container => container.style.display = 'none');
        });

        createElement('div', 'left-sidebar-blur', '', document.body).style.cssText = `
            position: fixed; top: 67px; left: 0; bottom: 0; width: 250px;
            background: rgba(128, 128, 128, 0.7);
            filter: blur(2px); z-index: 1000; cursor: not-allowed;
        `;

        createElement('div', 'import-buttons', '', document.body);

        dataToImportStep = data;
        importQueue = Object.keys(dataToImportStep.drawflow.Home.data);

        const importButtonsDiv = document.getElementById('import-buttons');
        createElement('div', 'step-info', '', importButtonsDiv);
        createElement('button', 'import-prev',
            '<i class="fas fa-arrow-left"></i> <span>{{_("Previous")}}</span>',
            importButtonsDiv).onclick = importPreviousComponent;
        createElement('button', 'import-next',
            '<i class="fas fa-arrow-right"></i> <span>{{_("Next")}}</span>',
            importButtonsDiv).onclick = importNextComponent;
        createElement('button', 'import-skip',
            '<i class="fas fa-forward"></i> <span>{{_("Skip")}}</span>',
            importButtonsDiv).onclick = importSkipComponent;
        createElement('button', 'import-quit',
            '<i class="fas fa-sign-out-alt"></i> <span>{{_("Quit")}}</span>',
            importButtonsDiv).onclick = importQuitComponent;
        createElement('div', 'step-warning',
            '{{_("Caution: You are currently in the tutorial mode where modifications are restricted.<br>Please click <strong>Quit</strong> to exit and start creating your custom multi-agent applications.")}}', document.body);

        accumulatedImportData = {};
        currentImportIndex = 0;
        importNextComponent();

        updateImportButtons();
    }

    function importPreviousComponent() {
        if (currentImportIndex > 0) {
            currentImportIndex--;
            accumulatedImportData = Object.assign({}, ...importQueue.slice(0, currentImportIndex).map(k => ({[k]: dataToImportStep.drawflow.Home.data[k]})));
            editor.import({drawflow: {Home: {data: accumulatedImportData}}});
            updateStepInfo();
        }
        updateImportButtons();
    }

    function importNextComponent() {
        const nodeId = importQueue[currentImportIndex];
        accumulatedImportData[nodeId] = dataToImportStep.drawflow.Home.data[nodeId];
        editor.import({drawflow: {Home: {data: accumulatedImportData}}});
        currentImportIndex++;
        updateStepInfo();
        updateImportButtons();
    }

    function importSkipComponent() {
        accumulatedImportData = Object.assign({}, ...importQueue.map(k => ({[k]: dataToImportStep.drawflow.Home.data[k]})));
        editor.import({drawflow: {Home: {data: accumulatedImportData}}});
        currentImportIndex = importQueue.length;
        updateImportButtons();
        updateStepInfo();
    }

    function importQuitComponent() {
        clearModuleSelected();
        ['buttons-container', 'buttons-container-html'].forEach(cls => {
            let containers = document.getElementsByClassName(cls);
            Array.from(containers).forEach(container => container.style.display = '');
        });
    }

    function updateStepInfo() {
        let stepInfoDiv = document.getElementById('step-info');
        if (stepInfoDiv && currentImportIndex > 0) {
            stepInfoDiv.innerHTML =
                `{{_("Current Step")}} (${currentImportIndex}/${importQueue.length}) <br> ${descriptionStep[currentImportIndex - 1]}`;
        } else if (stepInfoDiv) {
            stepInfoDiv.innerHTML = 'No steps to display.';
        }
    }

    function clearModuleSelected() {
        editor.clearModuleSelected();

        let importButtonsDiv = document.getElementById("import-buttons");
        if (importButtonsDiv) {
            importButtonsDiv.remove();
        }

        let stepWarningDiv = document.getElementById("step-warning");
        if (stepWarningDiv) {
            stepWarningDiv.remove();
        }

        let blurDiv = document.getElementById('left-sidebar-blur');
        if (blurDiv) {
            blurDiv.remove();
        }
    }

    function getCookie(name) {
        var matches = document.cookie.match(new RegExp(
            "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
        ));
        return matches ? decodeURIComponent(matches[1]) : undefined;
    }

    function showSurveyModal() {
        document.getElementById("surveyModal").style.display = "block";
    }

    function hideSurveyModal() {
        document.getElementById("surveyModal").style.display = "none";
    }

    document.getElementById('surveyButton').addEventListener('click', function () {
        window.open('https://survey.aliyun.com/apps/zhiliao/vgpTppn22', '_blank');
    });

    document.getElementById('surveyClose').addEventListener('click', function () {
        hideSurveyModal();
    });

    setTimeout(showSurveyModal, 30000);
</script>
</body>
</html>
